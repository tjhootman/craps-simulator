<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Craps Strategy Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg-color: #0f172a; --card-bg: #1e293b; --primary: #f43f5e; --accent: #22d3ee; --text-main: #f8fafc; --text-muted: #94a3b8; }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; padding: 40px 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 1200px; width: 100%; background: var(--card-bg); padding: 30px; border-radius: 16px; border: 1px solid #334155; }
        h1 { margin-top: 0; text-align: center; background: -webkit-linear-gradient(45deg, #f43f5e, #fbbf24); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; padding: 25px; background: #0f172a; border-radius: 12px; border: 1px solid #334155; }
        .control-group { display: flex; flex-direction: column; }
        .wide-input { grid-column: span 2; }
        label { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; margin-bottom: 8px; color: var(--text-muted); }
        input, select { background: #1e293b; color: white; padding: 0 12px; height: 45px; border: 1px solid #475569; border-radius: 8px; font-size: 0.95rem; width: 100%; }
        button { grid-column: 1 / -1; padding: 16px; background: linear-gradient(to right, #f43f5e, #e11d48); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .info-card { padding: 15px 20px; border-radius: 8px; background: rgba(255,255,255,0.05); }
        .chart-container { position: relative; height: 400px; width: 100%; background: #0f172a; border-radius: 12px; padding: 10px; border: 1px solid #334155; }
        .stats-bar { display: flex; justify-content: space-around; margin-bottom: 20px; padding: 20px; background: #0f172a; border-radius: 12px; }
        .stat-val { font-size: 1.8rem; font-weight: 800; display: block; }
        @media (max-width: 800px) { .controls { grid-template-columns: 1fr 1fr; } .wide-input { grid-column: span 1; } button { grid-column: span 2; } }
    </style>
</head>
<body>

<div class="container">
    <h1>Craps Profit & Variance Simulator</h1>

    <div class="controls">
        <div class="control-group">
            <label>Start Bankroll ($)</label>
            <input type="number" id="bankroll" value="2000" min="50">
        </div>
        <div class="control-group">
            <label>Min Table Bet ($)</label>
            <input type="number" id="minBet" value="10" min="5">
        </div>
        <div class="control-group">
            <label style="color: #67e8f9;">Stop Pressing At ($)</label>
            <input type="number" id="pressLimit" value="150" min="10">
        </div>
        <div class="control-group">
            <label>Simulations</label>
            <input type="number" id="sims" value="50" max="100">
        </div>

        <div class="control-group wide-input">
            <label style="color: #fca5a5;">Betting Strategy</label>
            <select id="strategy">
                <option value="pass_odds">Pass Line + Max Odds</option>
                <option value="iron_cross">Iron Cross (Action)</option>
                <option value="place_68">Place 6 & 8</option>
                <option value="dark_side">Dark Side (Don't Pass)</option>
            </select>
        </div>
        <div class="control-group wide-input">
            <label style="color: #67e8f9;">Profit Strategy</label>
            <select id="pressMode">
                <option value="collect">Collect (Safe)</option>
                <option value="press_half">Press Half (Balanced)</option>
                <option value="press_full">Power Press (Risky)</option>
            </select>
        </div>

        <button id="runBtn" onclick="handleRun()">Roll The Dice</button>
    </div>

    <div class="stats-bar">
        <div class="stat-box"><span class="stat-val" id="stat-ror">0%</span><span class="stat-label">Risk of Ruin</span></div>
        <div class="stat-box"><span class="stat-val" id="stat-avg">$0</span><span class="stat-label">Avg Result</span></div>
        <div class="stat-box"><span class="stat-val" id="stat-max">$0</span><span class="stat-label">Max Win</span></div>
    </div>

    <div class="chart-container">
        <canvas id="chartCanvas"></canvas>
    </div>
</div>

<script>
    Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
    let myChart = null;
    const USD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
    const ODDS_PAYOUT = { 4: 2, 10: 2, 5: 1.5, 9: 1.5, 6: 1.2, 8: 1.2 }; 

    function handleRun() {
        const btn = document.getElementById('runBtn');
        btn.innerHTML = "Rolling..."; btn.disabled = true;
        setTimeout(() => { runSimulation(); btn.innerHTML = "Roll The Dice"; btn.disabled = false; }, 50);
    }

    function rollDice() { return Math.floor(Math.random() * 6) + 1 + Math.floor(Math.random() * 6) + 1; }

    function runSimulation() {
        let bankroll = parseFloat(document.getElementById('bankroll').value);
        let minBet = parseFloat(document.getElementById('minBet').value);
        let pressLimit = parseFloat(document.getElementById('pressLimit').value);
        let sims = parseInt(document.getElementById('sims').value);
        const strategy = document.getElementById('strategy').value;
        const pressMode = document.getElementById('pressMode').value;
        const maxRolls = 500;

        if (sims > 100) sims = 100;

        const allDatasets = [];
        let finalSum = 0; let maxWin = 0; let ruinedCount = 0;

        // CALCULATE TRUE MINIMUM COST PER STRATEGY
        let minStrategyCost = minBet; // Default
        if (strategy === 'iron_cross') minStrategyCost = minBet * 4.4; // $44 for $10 table (Field, 5, 6, 8)
        if (strategy === 'place_68') minStrategyCost = minBet * 2.4; // $24 for $10 table
        // Pass/Dark Side remains minBet

        for (let s = 0; s < sims; s++) {
            let cash = bankroll;
            let currentData = [{x: 0, y: cash}];
            let point = 0; 
            let activeBets = {}; 
            let isRuined = false;
            let unitSize = minBet; 

            for (let r = 1; r <= maxRolls; r++) {
                // THE FIX: Use Strategy Cost, not just $0
                if (cash < minStrategyCost) { isRuined = true; cash = 0; }
                
                if (!isRuined) {
                    // RESET LOGIC
                    if (strategy === 'iron_cross' && cash < unitSize * 4.4) unitSize = minBet;
                    if (strategy === 'place_68' && cash < unitSize * 2.4) unitSize = minBet;
                    if (strategy === 'pass_odds' && cash < unitSize * 3) unitSize = minBet;

                    const roll = rollDice();
                    let winnings = 0;
                    let losses = 0;

                    // 1. GAME EVENT
                    let event = 'neutral'; 
                    if (point === 0) {
                        if (roll === 7 || roll === 11) event = 'natural';
                        else if (roll === 2 || roll === 3 || roll === 12) event = 'craps';
                        else { point = roll; event = 'point_set'; }
                    } else {
                        if (roll === point) { event = 'point_hit'; point = 0; }
                        else if (roll === 7) { event = 'seven_out'; point = 0; }
                    }

                    // 2. PLACE BETS
                    if (point === 0) {
                        if (event === 'natural' || event === 'craps' || event === 'seven_out' || event === 'point_hit') {
                            unitSize = minBet; 
                        }
                        if (strategy === 'pass_odds' && !activeBets.pass) { cash -= minBet; activeBets.pass = minBet; }
                        if (strategy === 'dark_side' && !activeBets.dontpass) { cash -= minBet; activeBets.dontpass = minBet; }
                    } 
                    else {
                        function updateBet(betKey, targetAmt) {
                            if (!activeBets[betKey]) { 
                                activeBets[betKey] = targetAmt; cash -= targetAmt; 
                            } else if (activeBets[betKey] < targetAmt) {
                                cash -= (targetAmt - activeBets[betKey]); activeBets[betKey] = targetAmt;
                            } else if (activeBets[betKey] > targetAmt) {
                                cash += (activeBets[betKey] - targetAmt); activeBets[betKey] = targetAmt;
                            }
                        }

                        if (strategy === 'pass_odds' && activeBets.pass && cash > unitSize * 3) {
                            if (!activeBets.odds) { activeBets.odds = unitSize * 3; cash -= activeBets.odds; }
                        }

                        if (strategy === 'place_68' && cash > (unitSize+2)*2) {
                            if (point !== 6) updateBet('place6', unitSize + 2);
                            if (point !== 8) updateBet('place8', unitSize + 2);
                        }

                        if (strategy === 'iron_cross' && cash > unitSize * 4) {
                            if (point !== 5) updateBet('place5', unitSize);
                            if (point !== 6) updateBet('place6', unitSize + 2);
                            if (point !== 8) updateBet('place8', unitSize + 2);
                            if (!activeBets.field) { activeBets.field = unitSize; cash -= unitSize; }
                        }
                    }

                    // 3. RESOLVE
                    if (activeBets.pass) {
                        if (event === 'natural') winnings += activeBets.pass;
                        else if (event === 'craps') { losses += activeBets.pass; delete activeBets.pass; }
                        else if (event === 'point_hit') {
                            winnings += activeBets.pass;
                            if (activeBets.odds) { winnings += activeBets.odds * ODDS_PAYOUT[roll]; cash += activeBets.odds; delete activeBets.odds; }
                        } else if (event === 'seven_out') { losses += activeBets.pass + (activeBets.odds||0); delete activeBets.pass; delete activeBets.odds; }
                    }

                    if (activeBets.dontpass) {
                        if (event === 'natural') { losses += activeBets.dontpass; delete activeBets.dontpass; }
                        else if (event === 'craps' && roll !== 12) winnings += activeBets.dontpass;
                        else if (event === 'seven_out') winnings += activeBets.dontpass;
                        else if (event === 'point_hit') { losses += activeBets.dontpass; delete activeBets.dontpass; }
                    }

                    if (activeBets.field) {
                        if ([2,3,4,9,10,11,12].includes(roll)) {
                            let mult = (roll === 2 || roll === 12) ? 2 : 1;
                            winnings += activeBets.field * mult;
                            cash += activeBets.field; delete activeBets.field;
                        } else { losses += activeBets.field; delete activeBets.field; }
                    }

                    if (point !== 0 || event === 'seven_out') {
                        if (roll === 7) {
                            losses += (activeBets.place5||0) + (activeBets.place6||0) + (activeBets.place8||0);
                            delete activeBets.place5; delete activeBets.place6; delete activeBets.place8;
                        } else {
                            if (activeBets.place5 && roll === 5) winnings += activeBets.place5 * 1.4;
                            if (activeBets.place6 && roll === 6) winnings += activeBets.place6 * 1.166;
                            if (activeBets.place8 && roll === 8) winnings += activeBets.place8 * 1.166;
                        }
                    }

                    // 4. PRESS
                    if (winnings > 0) {
                        cash += winnings;
                        if (unitSize < pressLimit) {
                            if (pressMode === 'press_half') { unitSize += (minBet * 0.5); }
                            else if (pressMode === 'press_full') { 
                                if (winnings >= unitSize) unitSize = unitSize * 2; 
                                else unitSize += minBet;
                            }
                        }
                    }
                }
                currentData.push({x: r, y: cash});
            }
            
            finalSum += cash;
            if (cash > maxWin) maxWin = cash;
            if (isRuined) ruinedCount++;

            let color = 'rgba(255, 255, 255, 0.1)'; 
            let order = 1;
            if (isRuined) { color = 'rgba(239, 68, 68, 0.5)'; order = 2; }
            else if (cash > bankroll * 1.5) { color = '#fbbf24'; order = 4; }
            else if (cash > bankroll) { color = 'rgba(16, 185, 129, 0.5)'; order = 3; }

            allDatasets.push({
                label: `Sim ${s}`, data: currentData, borderColor: color,
                borderWidth: (order === 4) ? 2 : 1, pointRadius: 0, 
                fill: false, tension: 0.1, order: 100 - order
            });
        }

        const ror = ((ruinedCount / sims) * 100).toFixed(1);
        document.getElementById('stat-ror').innerText = `${ror}%`;
        document.getElementById('stat-ror').style.color = ror > 20 ? '#ef4444' : '#10b981';
        document.getElementById('stat-avg').innerText = USD.format(finalSum / sims);
        document.getElementById('stat-max').innerText = USD.format(maxWin);

        renderChart(allDatasets, bankroll, maxRolls);
    }

    function renderChart(datasets, startLine, maxX) {
        const ctx = document.getElementById('chartCanvas').getContext('2d');
        if (myChart) myChart.destroy();
        datasets.push({
            label: 'Start Bankroll', data: [{x: 0, y: startLine}, {x: maxX, y: startLine}],
            borderColor: '#fbbf24', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, order: 0
        });
        myChart = new Chart(ctx, {
            type: 'line', data: { datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false, animation: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                scales: {
                    x: { type: 'linear', display: true, grid: { color: 'rgba(255,255,255,0.05)' }, max: maxX },
                    y: { display: true, grid: { color: 'rgba(255,255,255,0.05)' } }
                }, elements: { line: { tension: 0 } }
            }
        });
    }

    handleRun();
</script>